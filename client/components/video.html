<!DOCTYPE html>
<html>
  <head>
    <title>Video Test - Direct R2 Playback</title>
    <meta charset="UTF-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #111;
        color: white;
      }
      .test {
        margin: 20px 0;
        padding: 20px;
        background: #222;
        border-radius: 8px;
      }
      video {
        width: 800px;
        max-width: 100%;
        margin: 20px 0;
        display: block;
        border: 2px solid #444;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .success {
        color: #4caf50;
      }
      .error {
        color: #f44336;
      }
    </style>
  </head>
  <body>
    <h1>üé¨ Video Streaming Test</h1>

    <div class="test">
      <h2>Test 1: Direct R2 URL</h2>
      <div id="test1-status">Click to test</div>
      <video id="video1" controls muted></video>
      <button onclick="testDirect()">Test Direct Playback</button>
    </div>

    <div class="test">
      <h2>Test 2: Blob URL Method</h2>
      <div id="test2-status">Click to test</div>
      <video id="video2" controls muted></video>
      <button onclick="testBlob()">Test Blob URL</button>
    </div>

    <div class="test">
      <h2>Test 3: Base64 Encoding</h2>
      <div id="test3-status">Click to test</div>
      <video id="video3" controls muted></video>
      <button onclick="testBase64()">Test Base64 (Small videos only)</button>
    </div>

    <div class="test">
      <h2>Test 4: Download and Play</h2>
      <div id="test4-status">Click to test</div>
      <video id="video4" controls muted></video>
      <button onclick="testDownload()">Download and Play</button>
    </div>

    <script>
      // REPLACE THIS WITH YOUR ACTUAL R2 VIDEO URL
      const R2_VIDEO_URL = "YOUR_DIRECT_R2_VIDEO_URL_HERE";

      function updateStatus(testId, message, isError = false) {
        const element = document.getElementById(testId);
        element.textContent = message;
        element.className = isError ? "error" : "success";
        console.log(message);
      }

      async function testDirect() {
        const video = document.getElementById("video1");
        updateStatus("test1-status", "Testing direct R2 playback...");

        try {
          video.src = R2_VIDEO_URL;
          video.load();

          await video.play();
          updateStatus("test1-status", "‚úÖ Direct playback successful!");
        } catch (error) {
          updateStatus("test1-status", `‚ùå Failed: ${error.message}`, true);

          // Try with different CORS attributes
          video.crossOrigin = "anonymous";
          video.load();

          try {
            await video.play();
            updateStatus(
              "test1-status",
              '‚úÖ Works with crossOrigin="anonymous"'
            );
          } catch (error2) {
            updateStatus(
              "test1-status",
              `‚ùå Still failed: ${error2.message}`,
              true
            );
          }
        }
      }

      async function testBlob() {
        const video = document.getElementById("video2");
        updateStatus("test2-status", "Fetching video as blob...");

        try {
          // Use a CORS proxy
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(
            R2_VIDEO_URL
          )}`;

          const response = await fetch(proxyUrl);
          const data = await response.json();

          if (data.contents) {
            const blob = new Blob([data.contents], { type: "video/mp4" });
            const blobUrl = URL.createObjectURL(blob);

            video.src = blobUrl;
            video.load();

            await video.play();
            updateStatus("test2-status", "‚úÖ Blob playback successful!");
          } else {
            throw new Error("No content received");
          }
        } catch (error) {
          updateStatus("test2-status", `‚ùå Failed: ${error.message}`, true);
        }
      }

      async function testBase64() {
        const video = document.getElementById("video3");
        updateStatus("test3-status", "Fetching and converting to Base64...");

        try {
          // This only works for small videos
          const response = await fetch(R2_VIDEO_URL);
          const blob = await response.blob();

          if (blob.size > 10 * 1024 * 1024) {
            // 10MB limit
            updateStatus("test3-status", "‚ùå Video too large for Base64", true);
            return;
          }

          const reader = new FileReader();
          reader.onload = function () {
            video.src = reader.result;
            video.load();
            video.play().then(() => {
              updateStatus("test3-status", "‚úÖ Base64 playback successful!");
            });
          };
          reader.readAsDataURL(blob);
        } catch (error) {
          updateStatus("test3-status", `‚ùå Failed: ${error.message}`, true);
        }
      }

      async function testDownload() {
        const video = document.getElementById("video4");
        updateStatus("test4-status", "Downloading video...");

        try {
          const link = document.createElement("a");
          link.href = R2_VIDEO_URL;
          link.download = "video.mp4";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          updateStatus(
            "test4-status",
            "‚úÖ Download started. Click the video to load downloaded file."
          );

          // Create file input for user to select downloaded file
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "video/*";
          input.onchange = function (e) {
            const file = e.target.files[0];
            const url = URL.createObjectURL(file);
            video.src = url;
            video.load();
            video.play();
            updateStatus("test4-status", "‚úÖ Playing downloaded file!");
          };
          input.click();
        } catch (error) {
          updateStatus("test4-status", `‚ùå Failed: ${error.message}`, true);
        }
      }

      // Auto-run first test
      window.onload = function () {
        console.log("Test page loaded");
        console.log("R2 URL:", R2_VIDEO_URL);
      };
    </script>
  </body>
</html>
